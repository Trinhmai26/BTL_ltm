package com.loginSystem.client;

import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;
import com.loginSystem.common.*;

import javax.swing.*;
import javax.swing.border.EmptyBorder;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.io.*;
import java.net.Socket;
import java.util.List;
import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.TimeUnit;

public class Client {
    private static final String SERVER_HOST = "localhost";
    private static final int SERVER_PORT = 12345;

    private Socket socket;
    private BufferedReader input;
    private PrintWriter output;
    private Gson gson;
    private User currentUser;

    // GUI
    private JFrame mainFrame;
    private CardLayout cardLayout;
    private JPanel mainPanel;
    // panel ch·ª©a c√°c card th·ª±c s·ª± (CardLayout)
    private JPanel contentPanel;
    // tr·∫°ng th√°i to√†n m√†n h√¨nh
    private boolean isFullScreen = true;

    public Client() {
        this.gson = new Gson();
        applyLookAndFeel();
        connectToServer();
        setupGUI();
    }

    private void applyLookAndFeel() {
        try {
            UIManager.setLookAndFeel(new com.formdev.flatlaf.FlatLightLaf());
            UIManager.put("Button.arc", 20);   // tƒÉng bo g√≥c n√∫t
            UIManager.put("TextComponent.arc", 15);
            UIManager.put("TabbedPane.showTabSeparators", true);
            UIManager.put("defaultFont", new Font("Segoe UI", Font.PLAIN, 15));
            UIManager.put("Panel.background", new Color(240, 246, 255));
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    // Helper: style n√∫t v·ªõi m√†u pastel, icon, b√≥ng ƒë·ªï
    private JButton styleButton(JButton b, Color bg, Color fg) {
        b.setBackground(bg);
        b.setForeground(fg);
        b.setFocusPainted(false);
        b.setOpaque(true);
        b.setBorder(new RoundedBorder(18));
        b.setFont(new Font("Segoe UI", Font.BOLD, 15));
        b.setCursor(new Cursor(Cursor.HAND_CURSOR));
        b.setMargin(new Insets(8, 18, 8, 18));
        // Th√™m b√≥ng ƒë·ªï cho n√∫t
        b.setUI(new javax.swing.plaf.basic.BasicButtonUI() {
            @Override
            public void paint(Graphics g, JComponent c) {
                Graphics2D g2 = (Graphics2D) g.create();
                g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                g2.setColor(new Color(200, 200, 200, 80));
                g2.fillRoundRect(2, c.getHeight()-6, c.getWidth()-4, 6, 12, 12);
                super.paint(g2, c);
                g2.dispose();
            }
        });
        return b;
    }

    // Vi·ªÅn bo tr√≤n nh·∫π + b√≥ng ƒë·ªï cho card
    private static class RoundedBorder implements javax.swing.border.Border {
        private final int radius;
        public RoundedBorder(int r) { this.radius = r; }
        public Insets getBorderInsets(Component c) { return new Insets(radius/2, radius/2, radius/2, radius/2); }
        public boolean isBorderOpaque() { return false; }
        public void paintBorder(Component c, Graphics g, int x, int y, int width, int height) {
            Graphics2D g2 = (Graphics2D) g.create();
            g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
            g2.setColor(new Color(180, 200, 230));
            g2.setStroke(new BasicStroke(2f));
            g2.drawRoundRect(x+1, y+1, width-3, height-3, radius, radius);
            // B√≥ng ƒë·ªï
            g2.setColor(new Color(180, 180, 180, 60));
            g2.fillRoundRect(x+6, y+height-12, width-12, 8, radius, radius);
            g2.dispose();
        }
    }

    // Gradient background cho outer panel
    private JPanel createGradientPanel() {
        return new JPanel() {
            @Override
            protected void paintComponent(Graphics g) {
                super.paintComponent(g);
                Graphics2D g2 = (Graphics2D) g;
                GradientPaint gp = new GradientPaint(0, 0, new Color(240,246,255), getWidth(), getHeight(), new Color(220,230,250));
                g2.setPaint(gp);
                g2.fillRect(0, 0, getWidth(), getHeight());
            }
        };
    }

    // ---------------- LOGIN PANEL ----------------
    private JPanel createLoginPanel() {
        JPanel outer = createGradientPanel();
        outer.setLayout(new GridBagLayout());
        GridBagConstraints ogbc = new GridBagConstraints();
        ogbc.insets = new Insets(8,8,8,8);
        ogbc.gridx = 0; ogbc.gridy = 0;

        JPanel card = new JPanel(new GridBagLayout()) {
            @Override
            protected void paintComponent(Graphics g) {
                super.paintComponent(g);
                Graphics2D g2 = (Graphics2D) g;
                g2.setColor(Color.WHITE);
                g2.fillRoundRect(0, 0, getWidth(), getHeight(), 32, 32);
            }
        };
        card.setBackground(new Color(255,255,255,220));
        card.setBorder(new RoundedBorder(24));
        card.setPreferredSize(new Dimension(420, 380));

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(12, 12, 12, 12);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.weightx = 1.0;

        JLabel titleLabel = new JLabel("ƒêƒÇNG NH·∫¨P H·ªÜ TH·ªêNG", JLabel.CENTER);
        titleLabel.setFont(new Font("Segoe UI", Font.BOLD, 32));
        titleLabel.setForeground(new Color(33, 33, 99));
        gbc.gridx = 0; gbc.gridy = 0; gbc.gridwidth = 2;
        gbc.insets = new Insets(24, 0, 18, 0);
        gbc.anchor = GridBagConstraints.CENTER;
        card.add(titleLabel, gbc);

        gbc.gridwidth = 1;
        gbc.insets = new Insets(10,10,10,10);

        gbc.anchor = GridBagConstraints.EAST;
        gbc.gridx = 0; gbc.gridy = 1;
        JLabel userLabel = new JLabel("T√™n ƒëƒÉng nh·∫≠p:");
        userLabel.setFont(new Font("Segoe UI", Font.PLAIN, 16));
        card.add(userLabel, gbc);

        gbc.anchor = GridBagConstraints.WEST;
        gbc.gridx = 1;
        JTextField usernameField = new JTextField(20);
        usernameField.setFont(new Font("Segoe UI", Font.PLAIN, 15));
        card.add(usernameField, gbc);

        gbc.anchor = GridBagConstraints.EAST;
        gbc.gridx = 0; gbc.gridy = 2;
        JLabel passLabel = new JLabel("M·∫≠t kh·∫©u:");
        passLabel.setFont(new Font("Segoe UI", Font.PLAIN, 16));
        card.add(passLabel, gbc);

        gbc.anchor = GridBagConstraints.WEST;
        gbc.gridx = 1;
        JPasswordField passwordField = new JPasswordField(20);
        passwordField.setFont(new Font("Segoe UI", Font.PLAIN, 15));
        card.add(passwordField, gbc);

        gbc.gridx = 0; gbc.gridy = 3; gbc.gridwidth = 2;
        gbc.insets = new Insets(24, 0, 12, 0);
        gbc.anchor = GridBagConstraints.CENTER;
        JButton loginButton = new JButton("ƒêƒÉng nh·∫≠p", UIManager.getIcon("OptionPane.informationIcon"));
        JButton registerButton = new JButton("ƒêƒÉng k√Ω", UIManager.getIcon("FileView.fileIcon"));
        JButton exitButton = new JButton("Tho√°t", UIManager.getIcon("OptionPane.errorIcon"));
        Color green = new Color(120, 200, 160);
        Color blue = new Color(120, 160, 220);
        Color red = new Color(244, 67, 54);
        styleButton(loginButton, green, Color.WHITE).setPreferredSize(new Dimension(140, 40));
        styleButton(registerButton, blue, Color.WHITE).setPreferredSize(new Dimension(140, 40));
        styleButton(exitButton, red, Color.WHITE).setPreferredSize(new Dimension(140, 40));
        JPanel btnPanel = new JPanel(new FlowLayout(FlowLayout.CENTER, 18, 0));
        btnPanel.setOpaque(false);
        btnPanel.add(loginButton);
        btnPanel.add(registerButton);
        btnPanel.add(exitButton);
        card.add(btnPanel, gbc);

        gbc.gridy = 4;
        JLabel statusLabel = new JLabel(" ");
        statusLabel.setFont(new Font("Segoe UI", Font.ITALIC, 14));
        statusLabel.setForeground(new Color(120,120,120));
        card.add(statusLabel, gbc);

        outer.add(card, ogbc);

        // Action (gi·ªØ nguy√™n logic)
        loginButton.addActionListener(e -> {
            String username = usernameField.getText().trim();
            String password = new String(passwordField.getPassword());

            User loginUser = new User();
            loginUser.setUsername(username);
            loginUser.setPassword(password);

            Message request = new Message(RequestType.LOGIN, "");
            request.setUser(loginUser);

            Message response = sendRequest(request);
            if (response != null && response.isSuccess()) {
                currentUser = response.getUser();
                if (currentUser.isAdmin()) {
                    cardLayout.show(contentPanel, "ADMIN");
                } else {
                    cardLayout.show(contentPanel, "USER");
                }
            } else {
                JOptionPane.showMessageDialog(mainFrame,
                        response != null ? response.getError() : "L·ªói k·∫øt n·ªëi",
                        "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i",
                        JOptionPane.ERROR_MESSAGE);
            }
        });

        registerButton.addActionListener(e -> cardLayout.show(contentPanel, "REGISTER"));
        exitButton.addActionListener(e -> {
            cleanup();
            System.exit(0);
        });

        // cho Enter k√≠ch ho·∫°t n√∫t ƒêƒÉng nh·∫≠p
        if (mainFrame != null) mainFrame.getRootPane().setDefaultButton(loginButton);

        return outer;
    }

    // ---------------- REGISTER PANEL ----------------
    private JPanel createRegisterPanel() {
        JPanel outer = createGradientPanel();
        outer.setLayout(new GridBagLayout());
        GridBagConstraints ogbc = new GridBagConstraints();
        ogbc.insets = new Insets(8,8,8,8);
        ogbc.gridx = 0; ogbc.gridy = 0;

        JPanel card = new JPanel(new GridBagLayout()) {
            @Override
            protected void paintComponent(Graphics g) {
                super.paintComponent(g);
                Graphics2D g2 = (Graphics2D) g;
                g2.setColor(Color.WHITE);
                g2.fillRoundRect(0, 0, getWidth(), getHeight(), 32, 32);
            }
        };
        card.setBackground(new Color(255,255,255,220));
        card.setBorder(new RoundedBorder(24));
        card.setPreferredSize(new Dimension(420, 480));

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(12,12,12,12);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.weightx = 1.0;

        JLabel titleLabel = new JLabel("ƒêƒÇNG K√ù T√ÄI KHO·∫¢N", JLabel.CENTER);
        titleLabel.setFont(new Font("Segoe UI", Font.BOLD, 26));
        gbc.gridx = 0; gbc.gridy = 0; gbc.gridwidth = 2; gbc.anchor = GridBagConstraints.CENTER;
        card.add(titleLabel, gbc);

        gbc.gridwidth = 1;
        gbc.anchor = GridBagConstraints.EAST;
        gbc.gridx = 0; gbc.gridy = 1;
        JLabel lblUser = new JLabel("T√™n ƒëƒÉng nh·∫≠p:");
        lblUser.setFont(new Font("Segoe UI", Font.PLAIN, 15));
        card.add(lblUser, gbc);
        gbc.gridx = 1; gbc.anchor = GridBagConstraints.WEST;
        JTextField usernameField = new JTextField(20);
        usernameField.setFont(new Font("Segoe UI", Font.PLAIN, 15));
        card.add(usernameField, gbc);

        gbc.gridx = 0; gbc.gridy = 2; gbc.anchor = GridBagConstraints.EAST;
        JLabel lblPass = new JLabel("M·∫≠t kh·∫©u:");
        lblPass.setFont(new Font("Segoe UI", Font.PLAIN, 15));
        card.add(lblPass, gbc);
        gbc.gridx = 1; gbc.anchor = GridBagConstraints.WEST;
        JPasswordField passwordField = new JPasswordField(20);
        passwordField.setFont(new Font("Segoe UI", Font.PLAIN, 15));
        card.add(passwordField, gbc);

        gbc.gridx = 0; gbc.gridy = 3; gbc.anchor = GridBagConstraints.EAST;
        JLabel lblName = new JLabel("H·ªç t√™n:");
        lblName.setFont(new Font("Segoe UI", Font.PLAIN, 15));
        card.add(lblName, gbc);
        gbc.gridx = 1; gbc.anchor = GridBagConstraints.WEST;
        JTextField fullNameField = new JTextField(20);
        fullNameField.setFont(new Font("Segoe UI", Font.PLAIN, 15));
        card.add(fullNameField, gbc);

        gbc.gridx = 0; gbc.gridy = 4; gbc.anchor = GridBagConstraints.EAST;
        JLabel lblPhone = new JLabel("S·ªë ƒëi·ªán tho·∫°i:");
        lblPhone.setFont(new Font("Segoe UI", Font.PLAIN, 15));
        card.add(lblPhone, gbc);
        gbc.gridx = 1; gbc.anchor = GridBagConstraints.WEST;
        JTextField phoneField = new JTextField(20);
        phoneField.setFont(new Font("Segoe UI", Font.PLAIN, 15));
        card.add(phoneField, gbc);

        gbc.gridx = 0; gbc.gridy = 5; gbc.anchor = GridBagConstraints.EAST;
        JLabel lblEmail = new JLabel("Email:");
        lblEmail.setFont(new Font("Segoe UI", Font.PLAIN, 15));
        card.add(lblEmail, gbc);
        gbc.gridx = 1; gbc.anchor = GridBagConstraints.WEST;
        JTextField emailField = new JTextField(20);
        emailField.setFont(new Font("Segoe UI", Font.PLAIN, 15));
        card.add(emailField, gbc);

        gbc.gridx = 0; gbc.gridy = 6; gbc.gridwidth = 2; gbc.anchor = GridBagConstraints.CENTER; gbc.insets = new Insets(24,0,12,0);
        JButton okButton = new JButton("ƒêƒÉng k√Ω", UIManager.getIcon("FileView.fileIcon"));
        JButton backButton = new JButton("Quay l·∫°i", UIManager.getIcon("OptionPane.warningIcon"));
        Color blue = new Color(120, 160, 220);
        Color lightOrange = new Color(255, 200, 160);
        styleButton(okButton, blue, Color.WHITE);
        styleButton(backButton, lightOrange, Color.WHITE);
        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.CENTER, 18, 0));
        buttonPanel.setOpaque(false);
        buttonPanel.add(okButton); buttonPanel.add(backButton);
        card.add(buttonPanel, gbc);

        outer.add(card, ogbc);

        // actions (gi·ªØ nguy√™n logic)
        okButton.addActionListener(e -> {
            User newUser = new User(
                    usernameField.getText().trim(),
                    new String(passwordField.getPassword()),
                    fullNameField.getText().trim(),
                    phoneField.getText().trim(),
                    emailField.getText().trim()
            );
            Message request = new Message(RequestType.REGISTER, "");
            request.setUser(newUser);
            Message response = sendRequest(request);

            if (response != null && response.isSuccess()) {
                JOptionPane.showMessageDialog(mainFrame,
                        "ƒêƒÉng k√Ω th√†nh c√¥ng!",
                        "Th√†nh c√¥ng", JOptionPane.INFORMATION_MESSAGE);
            } else {
                JOptionPane.showMessageDialog(mainFrame,
                        response != null ? response.getError() : "L·ªói k·∫øt n·ªëi",
                        "ƒêƒÉng k√Ω th·∫•t b·∫°i", JOptionPane.ERROR_MESSAGE);
            }
        });

        backButton.addActionListener(e -> cardLayout.show(contentPanel, "LOGIN"));

        return outer;
    }

    // ---------------- USER PANEL ----------------
    private JPanel createUserPanel() {
        JPanel panel = new JPanel(new BorderLayout());

        JTabbedPane tabbedPane = new JTabbedPane();
        tabbedPane.addTab("üë§ Th√¥ng tin c√° nh√¢n", createUserInfoTab());
        tabbedPane.addTab("üìú L·ªãch s·ª≠ ƒëƒÉng nh·∫≠p", createUserHistoryTab());
        tabbedPane.addTab("üìÇ Files", createUserFilesTab());
        tabbedPane.addTab("üí¨ H·ªó tr·ª£", createSupportTab());

        panel.add(tabbedPane, BorderLayout.CENTER);

        JButton logoutButton = new JButton("ƒêƒÉng xu·∫•t");
        styleButton(logoutButton, new Color(244, 67, 54), Color.WHITE); // ƒë·ªè cho ƒëƒÉng xu·∫•t
        logoutButton.addActionListener(e -> {
            sendRequest(new Message(RequestType.LOGOUT, ""));
            currentUser = null;
            cardLayout.show(contentPanel, "LOGIN");
        });
        panel.add(logoutButton, BorderLayout.SOUTH);

        return panel;
    }
    
    
    

    private JPanel createUserInfoTab() {
        JPanel panel = new JPanel(new GridBagLayout());
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(10, 10, 10, 10);

        JTextField nameField = new JTextField(20);
        JTextField phoneField = new JTextField(20);
        JTextField emailField = new JTextField(20);
        JPasswordField passField = new JPasswordField(20);

        panel.add(new JLabel("H·ªç t√™n:"), gbc); gbc.gridx = 1; panel.add(nameField, gbc);
        gbc.gridx = 0; gbc.gridy = 1; panel.add(new JLabel("ƒêi·ªán tho·∫°i:"), gbc); gbc.gridx = 1; panel.add(phoneField, gbc);
        gbc.gridx = 0; gbc.gridy = 2; panel.add(new JLabel("Email:"), gbc); gbc.gridx = 1; panel.add(emailField, gbc);
        gbc.gridx = 0; gbc.gridy = 3; panel.add(new JLabel("M·∫≠t kh·∫©u m·ªõi:"), gbc); gbc.gridx = 1; panel.add(passField, gbc);

        JButton updateBtn = new JButton("C·∫≠p nh·∫≠t");
        styleButton(updateBtn, new Color(76, 175, 80), Color.WHITE); // xanh cho c·∫≠p nh·∫≠t
        gbc.gridx = 0; gbc.gridy = 4; gbc.gridwidth = 2;
        panel.add(updateBtn, gbc);

        updateBtn.addActionListener(e -> {
            User u = new User();
            u.setUsername(currentUser.getUsername());
            u.setFullName(nameField.getText().trim());
            u.setPhone(phoneField.getText().trim());
            u.setEmail(emailField.getText().trim());
            u.setPassword(new String(passField.getPassword()));

            Message req = new Message(RequestType.UPDATE_USER, "");
            req.setUser(u);
            Message resp = sendRequest(req);
            JOptionPane.showMessageDialog(mainFrame,
                    resp != null && resp.isSuccess() ? "C·∫≠p nh·∫≠t OK" : "C·∫≠p nh·∫≠t l·ªói");
        });

        return panel;
    }

    private JPanel createUserHistoryTab() {
        JPanel panel = new JPanel(new BorderLayout());
        JTextArea area = new JTextArea(); 
        area.setEditable(false);

        // Auto refresh m·ªói 5 gi√¢y
        Timer timer = new Timer(5000, e -> {
            if (currentUser != null) {
                Message req = new Message(RequestType.GET_LOGIN_HISTORY, currentUser.getUsername());
                Message resp = sendRequest(req);
                if (resp != null && resp.isSuccess()) {
                    // üëá In ra JSON server tr·∫£ v·ªÅ
//                    System.out.println("DEBUG JSON (user history): " + resp.getContent());

                    List<String> logs = gson.fromJson(
                            resp.getContent(),
                            new TypeToken<List<String>>(){}.getType()
                    );

                    StringBuilder sb = new StringBuilder();
                    for (String r : logs) {
                        sb.append(r).append("\n");
                    }
                    area.setText(sb.toString());
                }
            }
        });
        timer.start();

        panel.add(new JScrollPane(area), BorderLayout.CENTER);
        return panel;
    }



    private JPanel createUserFilesTab() {
        JPanel panel = new JPanel(new FlowLayout());
        JButton upload = new JButton("Upload");
        JButton download = new JButton("Download");
        styleButton(upload, new Color(76, 175, 80), Color.WHITE);
        styleButton(download, new Color(76, 175, 80), Color.WHITE);
        panel.add(upload); panel.add(download);

        upload.addActionListener(e -> {
            JFileChooser fc = new JFileChooser();
            if (fc.showOpenDialog(mainFrame) == JFileChooser.APPROVE_OPTION) {
                try {
                    File f = fc.getSelectedFile();
                    byte[] data = java.nio.file.Files.readAllBytes(f.toPath());
                    String b64 = java.util.Base64.getEncoder().encodeToString(data);
                    Message req = new Message(RequestType.UPLOAD_FILE, f.getName() + "|" + b64);
                    Message resp = sendRequest(req);
                    JOptionPane.showMessageDialog(mainFrame, resp.getContent());
                } catch (Exception ex) { ex.printStackTrace(); }
            }
        });

        download.addActionListener(e -> {
            String name = JOptionPane.showInputDialog("T√™n file:");
            if (name != null) {
                Message req = new Message(RequestType.DOWNLOAD_FILE, name);
                Message resp = sendRequest(req);
                if (resp != null && resp.isSuccess()) {
                    try {
                        String[] parts = resp.getContent().split("\\|",2);
                        byte[] data = java.util.Base64.getDecoder().decode(parts[1]);
                        JFileChooser fc = new JFileChooser(); fc.setSelectedFile(new File(parts[0]));
                        if (fc.showSaveDialog(mainFrame)==JFileChooser.APPROVE_OPTION)
                            java.nio.file.Files.write(fc.getSelectedFile().toPath(), data);
                    } catch (Exception ex) { ex.printStackTrace(); }
                }
            }
        });
        return panel;
    }

    private JPanel createSupportTab() {
        JPanel panel = new JPanel(new BorderLayout());
        JTextArea msg = new JTextArea(); msg.setBorder(BorderFactory.createTitledBorder("Y√™u c·∫ßu h·ªó tr·ª£"));
        JButton send = new JButton("G·ª≠i");
        styleButton(send, new Color(76, 175, 80), Color.WHITE);
        send.addActionListener(e -> {
            Message req = new Message(RequestType.BROADCAST, "[Support] " + currentUser.getUsername() + ": " + msg.getText());
            sendRequest(req);
            msg.setText("");
        });
        panel.add(new JScrollPane(msg), BorderLayout.CENTER);
        panel.add(send, BorderLayout.SOUTH);
        return panel;
    }

    // ---------------- ADMIN PANEL ----------------
    private JPanel createAdminPanel() {
        JPanel panel = new JPanel(new BorderLayout());

        JTabbedPane tabs = new JTabbedPane();
        tabs.addTab("Dashboard", createDashboardTab());
        tabs.addTab("Users", createUserManagementTab());
        tabs.addTab("Login history", createAllHistoryTab());
        tabs.addTab("Broadcast", createBroadcastTab());

        panel.add(tabs, BorderLayout.CENTER);

        JButton logoutButton = new JButton("ƒêƒÉng xu·∫•t");
        styleButton(logoutButton, new Color(244, 67, 54), Color.WHITE);
        logoutButton.addActionListener(e -> {
            sendRequest(new Message(RequestType.LOGOUT, ""));
            currentUser = null;
            cardLayout.show(contentPanel, "LOGIN");
        });
        panel.add(logoutButton, BorderLayout.SOUTH);
        return panel;
    }

    private JPanel createDashboardTab() {
        JPanel panel = new JPanel(new BorderLayout());
        JTextArea area = new JTextArea();
        area.setEditable(false);

        panel.add(new JScrollPane(area), BorderLayout.CENTER);

        // Timer auto-refresh m·ªói 3 gi√¢y
        Timer timer = new Timer(3000, e -> {
            Message resp = sendRequest(new Message(RequestType.GET_STATS, ""));
            if (resp != null && resp.isSuccess()) {
                area.setText(resp.getContent());
            }
        });
        timer.start();

        return panel;
    }


    private JPanel createUserManagementTab() {
        JPanel panel = new JPanel(new BorderLayout());
        DefaultTableModel model = new DefaultTableModel(
                new Object[]{"Username","H·ªç t√™n","Email","ƒêi·ªán tho·∫°i","Admin","Locked"},0);
        JTable table = new JTable(model);

        // Auto refresh users m·ªói 5 gi√¢y
        Timer timer = new Timer(5000, e -> loadUsers(model));
        timer.start();

        JButton edit = new JButton("S·ª≠a");
        JButton del = new JButton("X√≥a");
        styleButton(edit, new Color(76, 175, 80), Color.WHITE);
        styleButton(del, new Color(255, 153, 102), Color.WHITE);

        edit.addActionListener(e -> {
            int row = table.getSelectedRow();
            if (row >= 0) {
                String username = (String) model.getValueAt(row,0);
                String fullName = (String) model.getValueAt(row,1);
                String email = (String) model.getValueAt(row,2);
                String phone = (String) model.getValueAt(row,3);
                boolean isAdmin = (Boolean) model.getValueAt(row,4);
                boolean isLocked = (Boolean) model.getValueAt(row,5);

                JTextField fnField = new JTextField(fullName);
                JTextField emailField = new JTextField(email);
                JTextField phoneField = new JTextField(phone);
                JCheckBox adminBox = new JCheckBox("Admin", isAdmin);
                JCheckBox lockedBox = new JCheckBox("B·ªã kh√≥a", isLocked);

                JPanel form = new JPanel(new GridLayout(5,2));
                form.add(new JLabel("H·ªç t√™n:")); form.add(fnField);
                form.add(new JLabel("Email:")); form.add(emailField);
                form.add(new JLabel("ƒêi·ªán tho·∫°i:")); form.add(phoneField);
                form.add(adminBox); form.add(lockedBox);

                int ok = JOptionPane.showConfirmDialog(mainFrame, form,
                        "S·ª≠a user: " + username, JOptionPane.OK_CANCEL_OPTION);
                if (ok == JOptionPane.OK_OPTION) {
                    // 1. Update info
                    User u = new User();
                    u.setUsername(username);
                    u.setFullName(fnField.getText().trim());
                    u.setEmail(emailField.getText().trim());
                    u.setPhone(phoneField.getText().trim());
                    u.setPassword(""); // kh√¥ng ƒë·ªïi m·∫≠t kh·∫©u

                    Message req = new Message(RequestType.UPDATE_USER, "");
                    req.setUser(u);
                    sendRequest(req);

                    // 2. Update role
                    Message roleReq = new Message(
                        RequestType.SET_ADMIN,
                        username + "," + adminBox.isSelected()
                    );
                    sendRequest(roleReq);

                    // 3. Lock/unlock
                    if (lockedBox.isSelected()) {
                        sendRequest(new Message(RequestType.LOCK_USER, username));
                    } else {
                        sendRequest(new Message(RequestType.UNLOCK_USER, username));
                    }

                    // Refresh l·∫°i b·∫£ng
                    loadUsers(model);
                }

            }
        });

        del.addActionListener(e -> {
            int row = table.getSelectedRow();
            if (row>=0) {
                String username = (String) model.getValueAt(row,0);
                sendRequest(new Message(RequestType.DELETE_USER, username));
            }
        });

        JPanel top = new JPanel(); top.add(edit); top.add(del);
        panel.add(top, BorderLayout.NORTH);
        panel.add(new JScrollPane(table), BorderLayout.CENTER);

        // L·∫ßn ƒë·∫ßu load
        loadUsers(model);
        return panel;
    }
    private JPanel createLoginHistoryTab() {
        JPanel panel = new JPanel(new BorderLayout());
        DefaultTableModel model = new DefaultTableModel(
                new Object[]{"Username","Time","Success","IP"},0);
        JTable table = new JTable(model);

        // Auto refresh m·ªói 5 gi√¢y
        Timer timer = new Timer(5000, e -> {
            Message resp = sendRequest(new Message("GET_LOGIN_HISTORY",""));
            if (resp!=null && resp.isSuccess()) {
                model.setRowCount(0);
                List<LoginRecord> list = gson.fromJson(resp.getContent(),
                        new com.google.gson.reflect.TypeToken<List<LoginRecord>>(){}.getType());
                for (LoginRecord r: list) {
                    model.addRow(new Object[]{r.getUsername(),r.getTime(),r.isSuccess(),r.getIp()});
                }
            }
        });
        timer.start();

        panel.add(new JScrollPane(table), BorderLayout.CENTER);
        return panel;
    }

    private void loadUsers(DefaultTableModel model) {
        Message resp = sendRequest(new Message(RequestType.GET_ALL_USERS,""));
        if (resp!=null && resp.isSuccess()) {
            model.setRowCount(0);
            List<User> list = gson.fromJson(resp.getContent(),
                    new com.google.gson.reflect.TypeToken<List<User>>(){}.getType());
            for (User u: list) {
                model.addRow(new Object[]{u.getUsername(),u.getFullName(),u.getEmail(),
                        u.getPhone(),u.isAdmin(),u.isLocked()});
            }
        }
    }


    private JPanel createAllHistoryTab() {
        JPanel panel = new JPanel(new BorderLayout());
        JTextArea area = new JTextArea(); 
        area.setEditable(false);

        // Auto refresh m·ªói 5 gi√¢y
        Timer timer = new Timer(5000, e -> {
            Message req = new Message(RequestType.GET_LOGIN_HISTORY, "ALL");
            Message resp = sendRequest(req);
            if (resp != null && resp.isSuccess()) {
            	List<String> logs = gson.fromJson(resp.getContent(),
            	        new TypeToken<List<String>>(){}.getType());
            	StringBuilder sb = new StringBuilder();
            	for (String r : logs) {
            	    sb.append(r).append("\n");
            	}
            	area.setText(sb.toString());

            }
        });
        timer.start();

        panel.add(new JScrollPane(area), BorderLayout.CENTER);
        return panel;
    }


    private JPanel createBroadcastTab() {
        JPanel panel = new JPanel(new BorderLayout());
        JTextArea msg = new JTextArea(); 
        msg.setBorder(BorderFactory.createTitledBorder("Th√¥ng b√°o"));
        JButton send = new JButton("G·ª≠i");
        styleButton(send, new Color(76, 175, 80), Color.WHITE);

        send.addActionListener(e -> {
            Message req = new Message(RequestType.BROADCAST, msg.getText());
            Message resp = sendRequest(req);
            msg.setText("");

            // ‚úÖ Th√™m x·ª≠ l√Ω cho ph·∫£n h·ªìi t·ª´ server
            if (resp != null && resp.isSuccess()) {
                JOptionPane.showMessageDialog(mainFrame,
                        resp.getContent(),     // ch·ªâ l·∫•y string th√¥i
                        "K·∫øt qu·∫£ Broadcast",
                        JOptionPane.INFORMATION_MESSAGE);
            } else {
                JOptionPane.showMessageDialog(mainFrame,
                        resp != null ? resp.getError() : "L·ªói k·∫øt n·ªëi",
                        "Broadcast th·∫•t b·∫°i",
                        JOptionPane.ERROR_MESSAGE);
            }
        });

        panel.add(new JScrollPane(msg), BorderLayout.CENTER);
        panel.add(send, BorderLayout.SOUTH);
        return panel;
    }


    // ---------------- UTILITIES ----------------
 // H√†ng ƒë·ª£i ƒë·ªÉ g·ª≠i k·∫øt qu·∫£ response v·ªÅ cho sendRequest
    private BlockingQueue<Message> responseQueue = new ArrayBlockingQueue<>(10);

    private Message sendRequest(Message request) {
        try {
            output.println(gson.toJson(request));
            // ch·ªù t·ªëi ƒëa 2 gi√¢y ƒë·ªÉ l·∫•y response
            Message resp = responseQueue.poll(2, TimeUnit.SECONDS);
            if (resp == null) {
                System.err.println("Timeout waiting for response");
            }
            return resp;
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }
    private void startListener() {
        Thread listener = new Thread(() -> {
            try {
                String line;
                while ((line = input.readLine()) != null) {
                    Message msg = gson.fromJson(line, Message.class);

                    if (RequestType.BROADCAST.equals(msg.getType())) {
                        if (msg.isSuccess() && msg.getContent().startsWith("ƒê√£ g·ª≠i")) {
                            // ƒê√¢y l√† response cho admin
                            responseQueue.offer(msg);
                        } else {
                            // ƒê√¢y l√† broadcast push
                            SwingUtilities.invokeLater(() ->
                                JOptionPane.showMessageDialog(mainFrame,
                                        msg.getContent(),
                                        "üì¢ Th√¥ng b√°o",
                                        JOptionPane.INFORMATION_MESSAGE));
                        }
                    } else {
                        responseQueue.offer(msg);
                    }

                }
            } catch (IOException e) {
                System.err.println("Listener stopped: " + e.getMessage());
            }
        });
        listener.setDaemon(true);
        listener.start();
    }



    private void cleanup() {
        try {
            if (socket != null) socket.close();
            if (input != null) input.close();
            if (output != null) output.close();
        } catch (IOException e) {
            System.err.println("Error cleaning up client: " + e.getMessage());
        }
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(Client::new);
    }
}
                    if (RequestType.BROADCAST.equals(msg.getType())) {
                        if (msg.isSuccess() && msg.getContent().startsWith("ƒê√£ g·ª≠i")) {
                            // ƒê√¢y l√† response cho admin
                            responseQueue.offer(msg);
                        } else {
                            // ƒê√¢y l√† broadcast push
                            SwingUtilities.invokeLater(() ->
                                JOptionPane.showMessageDialog(mainFrame,
                                        msg.getContent(),
                                        "üì¢ Th√¥ng b√°o",
                                        JOptionPane.INFORMATION_MESSAGE));
                        }
                    } else {
                        responseQueue.offer(msg);
                    }

                }
            } catch (IOException e) {
                System.err.println("Listener stopped: " + e.getMessage());
            }
        });
        listener.setDaemon(true);
        listener.start();
    }



    private void cleanup() {
        try {
            if (socket != null) socket.close();
            if (input != null) input.close();
            if (output != null) output.close();
        } catch (IOException e) {
            System.err.println("Error cleaning up client: " + e.getMessage());
        }
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(Client::new);
    }
}
