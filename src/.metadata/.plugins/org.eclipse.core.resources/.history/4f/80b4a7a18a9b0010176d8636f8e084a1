package com.loginSystem.client;

import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;
import com.loginSystem.common.*;

import javax.swing.*;
import javax.swing.border.EmptyBorder;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.io.*;
import java.net.Socket;
import java.util.List;
import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.TimeUnit;

public class Client {
    private static final String SERVER_HOST = "localhost";
    private static final int SERVER_PORT = 12345;

    private Socket socket;
    private BufferedReader input;
    private PrintWriter output;
    private Gson gson;
    private User currentUser;

    // GUI
    private JFrame mainFrame;
    private CardLayout cardLayout;
    private JPanel mainPanel;
    // panel ch·ª©a c√°c card th·ª±c s·ª± (CardLayout)
    private JPanel contentPanel;
    // tr·∫°ng th√°i to√†n m√†n h√¨nh
    private boolean isFullScreen = true;

    public Client() {
        this.gson = new Gson();
        applyLookAndFeel();
        connectToServer();
        setupGUI();
    }

    private void applyLookAndFeel() {
        try {
            UIManager.setLookAndFeel(new com.formdev.flatlaf.FlatLightLaf());
            UIManager.put("Button.arc", 15);   // bo g√≥c n√∫t
            UIManager.put("TextComponent.arc", 10);
            UIManager.put("TabbedPane.showTabSeparators", true);
            // font m·∫∑c ƒë·ªãnh ·∫•m, d·ªÖ ƒë·ªçc
            UIManager.put("defaultFont", new Font("Segoe UI", Font.PLAIN, 14));
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    // Helper: style n√∫t v·ªõi m√†u ·∫•m, ch·ªØ tr·∫Øng v√† vi·ªÅn bo tr√≤n
    private JButton styleButton(JButton b, Color bg, Color fg) {
        b.setBackground(bg);
        b.setForeground(fg);
        b.setFocusPainted(false);
        b.setOpaque(true);
        b.setBorder(new RoundedBorder(12));
        b.setFont(new Font("Segoe UI", Font.BOLD, 13));
        return b;
    }

    // Vi·ªÅn bo tr√≤n nh·∫π
    private static class RoundedBorder implements javax.swing.border.Border {
        private final int radius;
        public RoundedBorder(int r) { this.radius = r; }
        public Insets getBorderInsets(Component c) { return new Insets(radius/2, radius/2, radius/2, radius/2); }
        public boolean isBorderOpaque() { return false; }
        public void paintBorder(Component c, Graphics g, int x, int y, int width, int height) {
            Graphics2D g2 = (Graphics2D) g.create();
            g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
            g2.setColor(new Color(200, 200, 200));
            g2.setStroke(new BasicStroke(1.2f));
            g2.drawRoundRect(x+1, y+1, width-3, height-3, radius, radius);
            g2.dispose();
        }
    }

    private void connectToServer() {
        try {
            socket = new Socket(SERVER_HOST, SERVER_PORT);
            input = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            output = new PrintWriter(socket.getOutputStream(), true);
            System.out.println("Connected to server");
            startListener();
        } catch (IOException e) {
            JOptionPane.showMessageDialog(null,
                    "Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server: " + e.getMessage(),
                    "L·ªói k·∫øt n·ªëi", JOptionPane.ERROR_MESSAGE);
            System.exit(1);
        }
    }

    private void setupGUI() {
        mainFrame = new JFrame("üîí H·ªá th·ªëng ƒëƒÉng nh·∫≠p");
        // Thi·∫øt l·∫≠p to√†n m√†n h√¨nh kh√¥ng vi·ªÅn tr∆∞·ªõc khi hi·ªÉn th·ªã
        mainFrame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        mainFrame.setUndecorated(true);
        mainFrame.setExtendedState(JFrame.MAXIMIZED_BOTH);
        mainFrame.setLocationRelativeTo(null);

        // S·ª≠ d·ª•ng BorderLayout cho mainPanel v√† ƒë·∫∑t content (card) v√†o gi·ªØa b·∫±ng wrapper
        cardLayout = new CardLayout();
        this.contentPanel = new JPanel(cardLayout);
        this.contentPanel.setOpaque(false); // ƒë·ªÉ wrapper n·ªÅn hi·ªÉn th·ªã
        // cho ph√©p contentPanel m·ªü r·ªông
        this.contentPanel.setPreferredSize(null);

        this.contentPanel.add(createLoginPanel(), "LOGIN");
        this.contentPanel.add(createRegisterPanel(), "REGISTER");
        this.contentPanel.add(createUserPanel(), "USER");
        this.contentPanel.add(createAdminPanel(), "ADMIN");

        mainPanel = new JPanel(new BorderLayout());
        mainPanel.setBackground(new Color(245,247,250));

        // wrapper gi√∫p cƒÉn gi·ªØa c·∫£ contentPanel
        JPanel centerWrapper = new JPanel(new GridBagLayout());
        centerWrapper.setOpaque(false);
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.gridx = 0;
        gbc.gridy = 0;
        // cho contentPanel chi·∫øm h·∫øt kh√¥ng gian ngang v√† d·ªçc
        gbc.fill = GridBagConstraints.BOTH;
        gbc.weightx = 1.0;
        gbc.weighty = 1.0;
        gbc.anchor = GridBagConstraints.CENTER;
        centerWrapper.add(this.contentPanel, gbc);

        mainPanel.add(centerWrapper, BorderLayout.CENTER);

        mainFrame.add(mainPanel);
        mainFrame.setVisible(true);

        // ƒêƒÉng k√Ω ESC ƒë·ªÉ toggle full screen / windowed (ESC s·∫Ω chuy·ªÉn sang c·ª≠a s·ªï c√≥ khung)
        mainFrame.getRootPane().getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW)
                .put(KeyStroke.getKeyStroke("ESCAPE"), "toggleFullscreen");
        mainFrame.getRootPane().getActionMap()
                .put("toggleFullscreen", new AbstractAction() {
                    @Override
                    public void actionPerformed(ActionEvent e) { toggleFullScreen(); }
                });

        cardLayout.show(this.contentPanel, "LOGIN");
    }

    private void toggleFullScreen() {
        // ƒê·ªïi tr·∫°ng th√°i to√†n m√†n h√¨nh an to√†n (c·∫ßn dispose ƒë·ªÉ ƒë·ªïi undecorated)
        boolean newFull = !isFullScreen;
        // l∆∞u v·ªã tr√≠/size hi·ªán t·∫°i n·∫øu c·∫ßn (gi·ªØ ƒë∆°n gi·∫£n)
        mainFrame.dispose();
        mainFrame.setUndecorated(newFull);
        if (newFull) {
            mainFrame.setExtendedState(JFrame.MAXIMIZED_BOTH);
        } else {
            mainFrame.setExtendedState(JFrame.NORMAL);
            mainFrame.setSize(1000, 700);
            mainFrame.setLocationRelativeTo(null);
        }
        isFullScreen = newFull;
        mainFrame.setVisible(true);
    }

    // ---------------- LOGIN PANEL ----------------
    private JPanel createLoginPanel() {
        // outer panel s·ª≠ d·ª•ng ƒë·ªÉ t·∫°o background
        JPanel outer = new JPanel(new GridBagLayout());
        outer.setBackground(new Color(245, 247, 250));
        GridBagConstraints ogbc = new GridBagConstraints();
        ogbc.insets = new Insets(8,8,8,8);
        ogbc.gridx = 0; ogbc.gridy = 0;

        // card tr·∫Øng ·ªü gi·ªØa ch·ª©a form (k√≠ch th∆∞·ªõc c·ªë ƒë·ªãnh ƒë·ªÉ d·ªÖ cƒÉn ch·ªânh)
        JPanel card = new JPanel(new GridBagLayout());
        card.setBackground(Color.WHITE);
        card.setBorder(new EmptyBorder(24, 28, 24, 28));
        // kh√¥ng ƒë·∫∑t preferred size ƒë·ªÉ card c√≥ th·ªÉ m·ªü r·ªông theo chi·ªÅu ngang
        card.setPreferredSize(null);

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(8, 8, 8, 8);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.weightx = 1.0;

        JLabel titleLabel = new JLabel("ƒêƒÇNG NH·∫¨P H·ªÜ TH·ªêNG");
        titleLabel.setFont(new Font("Segoe UI", Font.BOLD, 26));
        titleLabel.setForeground(new Color(33, 33, 99));
        gbc.gridx = 0; gbc.gridy = 0; gbc.gridwidth = 2;
        gbc.insets = new Insets(16, 0, 12, 0);
        gbc.anchor = GridBagConstraints.CENTER;
        card.add(titleLabel, gbc);

        gbc.gridwidth = 1;
        gbc.insets = new Insets(6,6,6,6);

        // Labels ·ªü c·ªôt 0 cƒÉn ph·∫£i, fields ·ªü c·ªôt 1 fill ngang
        gbc.anchor = GridBagConstraints.EAST;
        gbc.gridx = 0; gbc.gridy = 1;
        JLabel userLabel = new JLabel("T√™n ƒëƒÉng nh·∫≠p:");
        card.add(userLabel, gbc);

        gbc.anchor = GridBagConstraints.WEST;
        gbc.gridx = 1;
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.weightx = 1.0;
        JTextField usernameField = new JTextField(20);
        card.add(usernameField, gbc);

        gbc.fill = GridBagConstraints.NONE;
        gbc.weightx = 0;
        gbc.anchor = GridBagConstraints.EAST;
        gbc.gridx = 0; gbc.gridy = 2;
        JLabel passLabel = new JLabel("M·∫≠t kh·∫©u:");
        card.add(passLabel, gbc);

        gbc.anchor = GridBagConstraints.WEST;
        gbc.gridx = 1;
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.weightx = 1.0;
        JPasswordField passwordField = new JPasswordField(20);
        card.add(passwordField, gbc);

        // Buttons
        gbc.fill = GridBagConstraints.NONE;
        gbc.weightx = 0;
        gbc.gridx = 0; gbc.gridy = 3; gbc.gridwidth = 2;
        gbc.insets = new Insets(18, 0, 6, 0);
        gbc.anchor = GridBagConstraints.CENTER;
        JButton loginButton = new JButton("ƒêƒÉng nh·∫≠p");
        JButton registerButton = new JButton("ƒêƒÉng k√Ω");
        JButton exitButton = new JButton("Tho√°t");
        // Palette per request: login = green, register = blue, exit = red
        Color green = new Color(76, 175, 80);
        Color blue = new Color(33, 150, 243);
        Color red = new Color(244, 67, 54);
        styleButton(loginButton, green, Color.WHITE).setPreferredSize(new Dimension(120, 36));
        styleButton(registerButton, blue, Color.WHITE).setPreferredSize(new Dimension(120, 36));
        styleButton(exitButton, red, Color.WHITE).setPreferredSize(new Dimension(120, 36));
        JPanel btnPanel = new JPanel();
        btnPanel.setOpaque(false);
        btnPanel.add(loginButton);
        btnPanel.add(registerButton);
        btnPanel.add(exitButton);
        card.add(btnPanel, gbc);

        // Status line
        gbc.gridy = 4;
        JLabel statusLabel = new JLabel(" ");
        statusLabel.setFont(new Font("Segoe UI", Font.ITALIC, 13));
        statusLabel.setForeground(new Color(120,120,120));
        card.add(statusLabel, gbc);

        // th√™m card v√†o outer (ƒë·ªÉ outer l√†m background)
        outer.add(card, ogbc);

        // Action (gi·ªØ nguy√™n logic)
        loginButton.addActionListener(e -> {
            String username = usernameField.getText().trim();
            String password = new String(passwordField.getPassword());

            User loginUser = new User();
            loginUser.setUsername(username);
            loginUser.setPassword(password);

            Message request = new Message(RequestType.LOGIN, "");
            request.setUser(loginUser);

            Message response = sendRequest(request);
            if (response != null && response.isSuccess()) {
                currentUser = response.getUser();
                if (currentUser.isAdmin()) {
                    cardLayout.show(contentPanel, "ADMIN");
                } else {
                    cardLayout.show(contentPanel, "USER");
                }
            } else {
                JOptionPane.showMessageDialog(mainFrame,
                        response != null ? response.getError() : "L·ªói k·∫øt n·ªëi",
                        "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i",
                        JOptionPane.ERROR_MESSAGE);
            }
        });

        registerButton.addActionListener(e -> cardLayout.show(contentPanel, "REGISTER"));
        exitButton.addActionListener(e -> {
            cleanup();
            System.exit(0);
        });

        // cho Enter k√≠ch ho·∫°t n√∫t ƒêƒÉng nh·∫≠p
        if (mainFrame != null) mainFrame.getRootPane().setDefaultButton(loginButton);

        return outer;
    }

    // ---------------- REGISTER PANEL ----------------
    private JPanel createRegisterPanel() {
        JPanel outer = new JPanel(new GridBagLayout());
        outer.setBackground(new Color(245,247,250));
        GridBagConstraints ogbc = new GridBagConstraints();
        ogbc.insets = new Insets(8,8,8,8);
        ogbc.gridx = 0; ogbc.gridy = 0;

        JPanel card = new JPanel(new GridBagLayout());
        card.setBackground(Color.WHITE);
        card.setBorder(new EmptyBorder(20, 24, 20, 24));
        // cho ph√©p card co gi√£n theo chi·ªÅu ngang
        card.setPreferredSize(null);

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(8,8,8,8);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.weightx = 1.0;

        JLabel titleLabel = new JLabel("ƒêƒÇNG K√ù T√ÄI KHO·∫¢N");
        titleLabel.setFont(new Font("Segoe UI", Font.BOLD, 20));
        gbc.gridx = 0; gbc.gridy = 0; gbc.gridwidth = 2; gbc.anchor = GridBagConstraints.CENTER;
        card.add(titleLabel, gbc);

        gbc.gridwidth = 1;
        gbc.anchor = GridBagConstraints.EAST;
        gbc.gridx = 0; gbc.gridy = 1;
        card.add(new JLabel("T√™n ƒëƒÉng nh·∫≠p:"), gbc);
        gbc.gridx = 1; gbc.anchor = GridBagConstraints.WEST; gbc.fill = GridBagConstraints.HORIZONTAL; gbc.weightx = 1.0;
        JTextField usernameField = new JTextField(20);
        card.add(usernameField, gbc);

        gbc.fill = GridBagConstraints.NONE; gbc.weightx = 0;
        gbc.anchor = GridBagConstraints.EAST; gbc.gridx = 0; gbc.gridy = 2;
        card.add(new JLabel("M·∫≠t kh·∫©u:"), gbc);
        gbc.gridx = 1; gbc.anchor = GridBagConstraints.WEST; gbc.fill = GridBagConstraints.HORIZONTAL; gbc.weightx = 1.0;
        JPasswordField passwordField = new JPasswordField(20);
        card.add(passwordField, gbc);

        gbc.fill = GridBagConstraints.NONE; gbc.weightx = 0;
        gbc.anchor = GridBagConstraints.EAST; gbc.gridx = 0; gbc.gridy = 3;
        card.add(new JLabel("H·ªç t√™n:"), gbc);
        gbc.gridx = 1; gbc.anchor = GridBagConstraints.WEST; gbc.fill = GridBagConstraints.HORIZONTAL; gbc.weightx = 1.0;
        JTextField fullNameField = new JTextField(20);
        card.add(fullNameField, gbc);

        gbc.fill = GridBagConstraints.NONE; gbc.weightx = 0;
        gbc.anchor = GridBagConstraints.EAST; gbc.gridx = 0; gbc.gridy = 4;
        card.add(new JLabel("S·ªë ƒëi·ªán tho·∫°i:"), gbc);
        gbc.gridx = 1; gbc.anchor = GridBagConstraints.WEST; gbc.fill = GridBagConstraints.HORIZONTAL; gbc.weightx = 1.0;
        JTextField phoneField = new JTextField(20);
        card.add(phoneField, gbc);

        gbc.fill = GridBagConstraints.NONE; gbc.weightx = 0;
        gbc.anchor = GridBagConstraints.EAST; gbc.gridx = 0; gbc.gridy = 5;
        card.add(new JLabel("Email:"), gbc);
        gbc.gridx = 1; gbc.anchor = GridBagConstraints.WEST; gbc.fill = GridBagConstraints.HORIZONTAL; gbc.weightx = 1.0;
        JTextField emailField = new JTextField(20);
        card.add(emailField, gbc);

        gbc.fill = GridBagConstraints.NONE; gbc.weightx = 0;
        gbc.gridx = 0; gbc.gridy = 6; gbc.gridwidth = 2; gbc.anchor = GridBagConstraints.CENTER; gbc.insets = new Insets(16,0,8,0);
        JButton okButton = new JButton("ƒêƒÉng k√Ω");
        JButton backButton = new JButton("Quay l·∫°i");
        // ƒêƒÉng k√Ω = xanh d∆∞∆°ng, quay l·∫°i gi·ªØ m√†u ƒë·ªè-cam nh·∫π
        Color blue = new Color(33, 150, 243);
        Color lightOrange = new Color(255, 153, 102);
        styleButton(okButton, blue, Color.WHITE);
        styleButton(backButton, lightOrange, Color.WHITE);
        JPanel buttonPanel = new JPanel();
        buttonPanel.add(okButton); buttonPanel.add(backButton);
        card.add(buttonPanel, gbc);

        outer.add(card, ogbc);

        // actions (gi·ªØ nguy√™n logic)
        okButton.addActionListener(e -> {
            User newUser = new User(
                    usernameField.getText().trim(),
                    new String(passwordField.getPassword()),
                    fullNameField.getText().trim(),
                    phoneField.getText().trim(),
                    emailField.getText().trim()
            );
            Message request = new Message(RequestType.REGISTER, "");
            request.setUser(newUser);
            Message response = sendRequest(request);

            if (response != null && response.isSuccess()) {
                JOptionPane.showMessageDialog(mainFrame,
                        "ƒêƒÉng k√Ω th√†nh c√¥ng!",
                        "Th√†nh c√¥ng", JOptionPane.INFORMATION_MESSAGE);
            } else {
                JOptionPane.showMessageDialog(mainFrame,
                        response != null ? response.getError() : "L·ªói k·∫øt n·ªëi",
                        "ƒêƒÉng k√Ω th·∫•t b·∫°i", JOptionPane.ERROR_MESSAGE);
            }
        });

        backButton.addActionListener(e -> cardLayout.show(contentPanel, "LOGIN"));

        return outer;
    }

    // ---------------- USER PANEL ----------------
    private JPanel createUserPanel() {
        JPanel panel = new JPanel(new BorderLayout());

        JTabbedPane tabbedPane = new JTabbedPane();
        tabbedPane.addTab("üë§ Th√¥ng tin c√° nh√¢n", createUserInfoTab());
        tabbedPane.addTab("üìú L·ªãch s·ª≠ ƒëƒÉng nh·∫≠p", createUserHistoryTab());
        tabbedPane.addTab("üí¨ H·ªó tr·ª£", createSupportTab());

        panel.add(tabbedPane, BorderLayout.CENTER);

        JButton logoutButton = new JButton("ƒêƒÉng xu·∫•t");
        styleButton(logoutButton, new Color(244, 67, 54), Color.WHITE); // ƒë·ªè cho ƒëƒÉng xu·∫•t
        logoutButton.addActionListener(e -> {
            sendRequest(new Message(RequestType.LOGOUT, ""));
            currentUser = null;
            cardLayout.show(contentPanel, "LOGIN");
        });
        panel.add(logoutButton, BorderLayout.SOUTH);

        return panel;
    }

    private JPanel createUserInfoTab() {
        JPanel panel = new JPanel(new GridBagLayout());
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(10, 10, 10, 10);

        JTextField nameField = new JTextField(20);
        JTextField phoneField = new JTextField(20);
        JTextField emailField = new JTextField(20);
        JPasswordField passField = new JPasswordField(20);

        panel.add(new JLabel("H·ªç t√™n:"), gbc); gbc.gridx = 1; panel.add(nameField, gbc);
        gbc.gridx = 0; gbc.gridy = 1; panel.add(new JLabel("ƒêi·ªán tho·∫°i:"), gbc); gbc.gridx = 1; panel.add(phoneField, gbc);
        gbc.gridx = 0; gbc.gridy = 2; panel.add(new JLabel("Email:"), gbc); gbc.gridx = 1; panel.add(emailField, gbc);
        gbc.gridx = 0; gbc.gridy = 3; panel.add(new JLabel("M·∫≠t kh·∫©u m·ªõi:"), gbc); gbc.gridx = 1; panel.add(passField, gbc);

        JButton updateBtn = new JButton("C·∫≠p nh·∫≠t");
        styleButton(updateBtn, new Color(76, 175, 80), Color.WHITE); // xanh cho c·∫≠p nh·∫≠t
        gbc.gridx = 0; gbc.gridy = 4; gbc.gridwidth = 2;
        panel.add(updateBtn, gbc);

        updateBtn.addActionListener(e -> {
            User u = new User();
            u.setUsername(currentUser.getUsername());
            u.setFullName(nameField.getText().trim());
            u.setPhone(phoneField.getText().trim());
            u.setEmail(emailField.getText().trim());
            u.setPassword(new String(passField.getPassword()));

            Message req = new Message(RequestType.UPDATE_USER, "");
            req.setUser(u);
            Message resp = sendRequest(req);
            JOptionPane.showMessageDialog(mainFrame,
                    resp != null && resp.isSuccess() ? "C·∫≠p nh·∫≠t OK" : "C·∫≠p nh·∫≠t l·ªói");
        });

        return panel;
    }

   
    private JPanel createSupportTab() {
        JPanel panel = new JPanel(new BorderLayout());
        JTextArea msg = new JTextArea(); msg.setBorder(BorderFactory.createTitledBorder("Y√™u c·∫ßu h·ªó tr·ª£"));
        JButton send = new JButton("G·ª≠i");
        styleButton(send, new Color(76, 175, 80), Color.WHITE);
        send.addActionListener(e -> {
            Message req = new Message(RequestType.BROADCAST, "[Support] " + currentUser.getUsername() + ": " + msg.getText());
            sendRequest(req);
            msg.setText("");
        });
        panel.add(new JScrollPane(msg), BorderLayout.CENTER);
        panel.add(send, BorderLayout.SOUTH);
        return panel;
    }

    // ---------------- ADMIN PANEL ----------------
    private JPanel createAdminPanel() {
        JPanel panel = new JPanel(new BorderLayout());

        JTabbedPane tabs = new JTabbedPane();
        tabs.addTab("Dashboard", createDashboardTab());
        tabs.addTab("Users", createUserManagementTab());
        tabs.addTab("Login history", createAllHistoryTab());
        tabs.addTab("Broadcast", createBroadcastTab());

        panel.add(tabs, BorderLayout.CENTER);

        JButton logoutButton = new JButton("ƒêƒÉng xu·∫•t");
        styleButton(logoutButton, new Color(244, 67, 54), Color.WHITE);
        logoutButton.addActionListener(e -> {
            sendRequest(new Message(RequestType.LOGOUT, ""));
            currentUser = null;
            cardLayout.show(contentPanel, "LOGIN");
        });
        panel.add(logoutButton, BorderLayout.SOUTH);
        return panel;
    }

    private JPanel createDashboardTab() {
        JPanel panel = new JPanel(new BorderLayout());
        JTextArea area = new JTextArea();
        area.setEditable(false);

        panel.add(new JScrollPane(area), BorderLayout.CENTER);

        // Timer auto-refresh m·ªói 3 gi√¢y
        Timer timer = new Timer(3000, e -> {
            Message resp = sendRequest(new Message(RequestType.GET_STATS, ""));
            if (resp != null && resp.isSuccess()) {
                area.setText(resp.getContent());
            }
        });
        timer.start();

        return panel;
    }


    private JPanel createUserManagementTab() {
        JPanel panel = new JPanel(new BorderLayout());
        DefaultTableModel model = new DefaultTableModel(
                new Object[]{"Username","H·ªç t√™n","Email","ƒêi·ªán tho·∫°i","Admin","Locked"},0);
        JTable table = new JTable(model);

        // Auto refresh users m·ªói 5 gi√¢y
        Timer timer = new Timer(5000, e -> loadUsers(model));
        timer.start();

        JButton edit = new JButton("S·ª≠a");
        JButton del = new JButton("X√≥a");
        styleButton(edit, new Color(76, 175, 80), Color.WHITE);
        styleButton(del, new Color(255, 153, 102), Color.WHITE);

        edit.addActionListener(e -> {
            int row = table.getSelectedRow();
            if (row >= 0) {
                String username = (String) model.getValueAt(row,0);
                String fullName = (String) model.getValueAt(row,1);
                String email = (String) model.getValueAt(row,2);
                String phone = (String) model.getValueAt(row,3);
                boolean isAdmin = (Boolean) model.getValueAt(row,4);
                boolean isLocked = (Boolean) model.getValueAt(row,5);

                JTextField fnField = new JTextField(fullName);
                JTextField emailField = new JTextField(email);
                JTextField phoneField = new JTextField(phone);
                JCheckBox adminBox = new JCheckBox("Admin", isAdmin);
                JCheckBox lockedBox = new JCheckBox("B·ªã kh√≥a", isLocked);

                JPanel form = new JPanel(new GridLayout(5,2));
                form.add(new JLabel("H·ªç t√™n:")); form.add(fnField);
                form.add(new JLabel("Email:")); form.add(emailField);
                form.add(new JLabel("ƒêi·ªán tho·∫°i:")); form.add(phoneField);
                form.add(adminBox); form.add(lockedBox);

                int ok = JOptionPane.showConfirmDialog(mainFrame, form,
                        "S·ª≠a user: " + username, JOptionPane.OK_CANCEL_OPTION);
                if (ok == JOptionPane.OK_OPTION) {
                    // 1. Update info
                    User u = new User();
                    u.setUsername(username);
                    u.setFullName(fnField.getText().trim());
                    u.setEmail(emailField.getText().trim());
                    u.setPhone(phoneField.getText().trim());
                    u.setPassword(""); // kh√¥ng ƒë·ªïi m·∫≠t kh·∫©u

                    Message req = new Message(RequestType.UPDATE_USER, "");
                    req.setUser(u);
                    sendRequest(req);

                    // 2. Update role
                    Message roleReq = new Message(
                        RequestType.SET_ADMIN,
                        username + "," + adminBox.isSelected()
                    );
                    sendRequest(roleReq);

                    // 3. Lock/unlock
                    if (lockedBox.isSelected()) {
                        sendRequest(new Message(RequestType.LOCK_USER, username));
                    } else {
                        sendRequest(new Message(RequestType.UNLOCK_USER, username));
                    }

                    // Refresh l·∫°i b·∫£ng
                    loadUsers(model);
                }

            }
        });

        del.addActionListener(e -> {
            int row = table.getSelectedRow();
            if (row>=0) {
                String username = (String) model.getValueAt(row,0);
                sendRequest(new Message(RequestType.DELETE_USER, username));
            }
        });

        JPanel top = new JPanel(); top.add(edit); top.add(del);
        panel.add(top, BorderLayout.NORTH);
        panel.add(new JScrollPane(table), BorderLayout.CENTER);

        // L·∫ßn ƒë·∫ßu load
        loadUsers(model);
        return panel;
    }
    private JPanel createLoginHistoryTab() {
        JPanel panel = new JPanel(new BorderLayout());
        DefaultTableModel model = new DefaultTableModel(
                new Object[]{"Username","Time","Success","IP"},0);
        JTable table = new JTable(model);

        // Auto refresh m·ªói 5 gi√¢y
        Timer timer = new Timer(5000, e -> {
            Message resp = sendRequest(new Message("GET_LOGIN_HISTORY",""));
            if (resp!=null && resp.isSuccess()) {
                model.setRowCount(0);
                List<LoginRecord> list = gson.fromJson(resp.getContent(),
                        new com.google.gson.reflect.TypeToken<List<LoginRecord>>(){}.getType());
                for (LoginRecord r: list) {
                    model.addRow(new Object[]{r.getUsername(),r.getTime(),r.isSuccess(),r.getIp()});
                }
            }
        });
        timer.start();

        panel.add(new JScrollPane(table), BorderLayout.CENTER);
        return panel;
    }

    private void loadUsers(DefaultTableModel model) {
        Message resp = sendRequest(new Message(RequestType.GET_ALL_USERS,""));
        if (resp!=null && resp.isSuccess()) {
            model.setRowCount(0);
            List<User> list = gson.fromJson(resp.getContent(),
                    new com.google.gson.reflect.TypeToken<List<User>>(){}.getType());
            for (User u: list) {
                model.addRow(new Object[]{u.getUsername(),u.getFullName(),u.getEmail(),
                        u.getPhone(),u.isAdmin(),u.isLocked()});
            }
        }
    }


    private JPanel createAllHistoryTab() {
        JPanel panel = new JPanel(new BorderLayout());
        JTextArea area = new JTextArea(); 
        area.setEditable(false);

        // Auto refresh m·ªói 5 gi√¢y
        Timer timer = new Timer(5000, e -> {
            Message req = new Message(RequestType.GET_LOGIN_HISTORY, "ALL");
            Message resp = sendRequest(req);
            if (resp != null && resp.isSuccess()) {
            	List<String> logs = gson.fromJson(resp.getContent(),
            	        new TypeToken<List<String>>(){}.getType());
            	StringBuilder sb = new StringBuilder();
            	for (String r : logs) {
            	    sb.append(r).append("\n");
            	}
            	area.setText(sb.toString());

            }
        });
        timer.start();

        panel.add(new JScrollPane(area), BorderLayout.CENTER);
        return panel;
    }


    private JPanel createBroadcastTab() {
        JPanel panel = new JPanel(new BorderLayout());
        JTextArea msg = new JTextArea(); 
        msg.setBorder(BorderFactory.createTitledBorder("Th√¥ng b√°o"));
        JButton send = new JButton("G·ª≠i");
        styleButton(send, new Color(76, 175, 80), Color.WHITE);

        send.addActionListener(e -> {
            Message req = new Message(RequestType.BROADCAST, msg.getText());
            Message resp = sendRequest(req);
            msg.setText("");

            // ‚úÖ Th√™m x·ª≠ l√Ω cho ph·∫£n h·ªìi t·ª´ server
            if (resp != null && resp.isSuccess()) {
                JOptionPane.showMessageDialog(mainFrame,
                        resp.getContent(),     // ch·ªâ l·∫•y string th√¥i
                        "K·∫øt qu·∫£ Broadcast",
                        JOptionPane.INFORMATION_MESSAGE);
            } else {
                JOptionPane.showMessageDialog(mainFrame,
                        resp != null ? resp.getError() : "L·ªói k·∫øt n·ªëi",
                        "Broadcast th·∫•t b·∫°i",
                        JOptionPane.ERROR_MESSAGE);
            }
        });

        panel.add(new JScrollPane(msg), BorderLayout.CENTER);
        panel.add(send, BorderLayout.SOUTH);
        return panel;
    }


    // ---------------- UTILITIES ----------------
 // H√†ng ƒë·ª£i ƒë·ªÉ g·ª≠i k·∫øt qu·∫£ response v·ªÅ cho sendRequest
    private BlockingQueue<Message> responseQueue = new ArrayBlockingQueue<>(10);

    private Message sendRequest(Message request) {
        try {
            output.println(gson.toJson(request));
            // ch·ªù t·ªëi ƒëa 2 gi√¢y ƒë·ªÉ l·∫•y response
            Message resp = responseQueue.poll(2, TimeUnit.SECONDS);
            if (resp == null) {
                System.err.println("Timeout waiting for response");
            }
            return resp;
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }

    private void cleanup() {
        try {
            if (socket != null) socket.close();
            if (input != null) input.close();
            if (output != null) output.close();
        } catch (IOException e) {
            System.err.println("Error cleaning up client: " + e.getMessage());
        }
    }

    private void startListener() {
        Thread listener = new Thread(() -> {
            try {
                String line;
                while ((line = input.readLine()) != null) {
                    Message msg = gson.fromJson(line, Message.class);

                    if (RequestType.BROADCAST.equals(msg.getType())) {
                        if (msg.isSuccess() && msg.getContent().startsWith("ƒê√£ g·ª≠i")) {
                            responseQueue.offer(msg);
                        } else {
                            SwingUtilities.invokeLater(() ->
                                JOptionPane.showMessageDialog(mainFrame,
                                        msg.getContent(),
                                        "üì¢ Th√¥ng b√°o",
                                        JOptionPane.INFORMATION_MESSAGE));
                        }
                    } else {
                        responseQueue.offer(msg);
                    }
                }
            } catch (IOException e) {
                System.err.println("Listener stopped: " + e.getMessage());
            }
        });
        listener.setDaemon(true);
        listener.start();
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(Client::new);
    }
}
    }
}
    }
}
        Thread listener = new Thread(() -> {
            try {
                String line;
                while ((line = input.readLine()) != null) {
                    Message msg = gson.fromJson(line, Message.class);

                    if (RequestType.BROADCAST.equals(msg.getType())) {
                        if (msg.isSuccess() && msg.getContent().startsWith("ƒê√£ g·ª≠i")) {
                            // ƒê√¢y l√† response cho admin
                            responseQueue.offer(msg);
                        } else {
                            // ƒê√¢y l√† broadcast push
                            SwingUtilities.invokeLater(() ->
                                JOptionPane.showMessageDialog(mainFrame,
                                        msg.getContent(),
                                        "üì¢ Th√¥ng b√°o",
                                        JOptionPane.INFORMATION_MESSAGE));
                        }
                    } else {
                        responseQueue.offer(msg);
                    }

                }
            } catch (IOException e) {
                System.err.println("Listener stopped: " + e.getMessage());
            }
        
        listener.setDaemon(true);
        listener.start();




    private void cleanup() {
        try {
            if (socket != null) socket.close();
            if (input != null) input.close();
            if (output != null) output.close();
        } catch (IOException e) {
            System.err.println("Error cleaning up client: " + e.getMessage());
        }
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(Client::new);
    }
}
